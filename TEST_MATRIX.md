# Paper Interpreter - 测试与验证矩阵

---

## 1. 正常触发测试

| 测试ID | 场景 | 输入 | 期望结果 | 验证方式 |
|-------|------|------|---------|---------|
| T-001 | arXiv abstract 链接 | `/paper-interpreter https://arxiv.org/abs/2312.00752` | 成功下载并解析，输出完整文章 | 检查输出目录是否存在所有预期文件 |
| T-002 | arXiv PDF 直接链接 | `/paper-interpreter https://arxiv.org/pdf/2312.00752.pdf` | 直接下载 PDF，跳过 abstract 页解析 | 验证下载时间 < 5 秒 |
| T-003 | DOI 链接 | `/paper-interpreter https://doi.org/10.1145/276675.276685` | 解析重定向，下载对应论文 | 验证 PDF 完整性 |
| T-004 | OpenReview 链接 | `/paper-interpreter https://openreview.net/forum?id=xxxxx` | 提取 OpenReview 元数据并下载 | 验证作者信息正确 |
| T-005 | 直接 PDF 链接 | `/paper-interpreter https://example.com/paper.pdf` | 使用通用下载方案 | 验证文件大小 > 0 |

---

## 2. 边缘情况测试

### 2.1 输入数据缺失处理

| 测试ID | 场景 | 缺失数据 | 预期行为 | 验证点 |
|-------|------|---------|---------|-------|
| E-001 | 发表日期缺失 | `publication_date` | 从 arXiv ID 推断日期，或使用"未知日期" | 输出文章包含有效日期 |
| E-002 | 机构信息缺失 | `institution` | 使用"未知机构"占位符 | 不中断流程 |
| E-003 | DOI 缺失 | `doi` | 跳过 DOI 字段 | 输出不包含 DOI |
| E-004 | 摘要缺失 | `abstract` | 使用第一段内容作为摘要 | 生成文章有引言内容 |
| E-005 | 作者信息缺失 | `authors` | 使用"未知作者" | 元数据文件完整 |

### 2.2 自动化决策验证

| 测试ID | 场景 | 触发条件 | 预期行为 | 验证点 |
|-------|------|---------|---------|-------|
| E-006 | 链接格式不支持 | 非标准 URL 格式 | 尝试通用下载方案 | 尝试使用 requests |
| E-007 | 通用下载失败 | 404/403 错误 | 记录错误并退出 | error.log 有记录 |
| E-008 | PDF 验证失败 | 文件头不是 %PDF | 尝试修复或退出 | 正确处理损坏文件 |
| E-009 | 内容提取不完整 | unstructured 失败 | 使用 PyPDF2 降级 | 至少提取标题和摘要 |
| E-010 | 配图生成失败 | API 错误/超时 | 跳过该配图，继续流程 | 文章生成完成，缺失处显示占位符 |
| E-011 | 所有配图失败 | API 完全不可用 | 无配图继续生成文章 | PDF 输出成功，无图片错误 |
| E-012 | 文件已存在 | 同名目录存在 | 添加时间戳后缀创建新目录 | 新旧目录并存 |
| E-013 | 内容超长 | 论文字数 > 15000 | 自动分块生成，合并输出 | 完整文章内容，无截断 |
| E-014 | PDF 导出失败 | pandoc 不可用 | 返回 HTML 作为最终输出 | 用户获得可用文件 |

### 2.3 超时与性能

| 测试ID | 场景 | 阈值 | 预期行为 | 验证点 |
|-------|------|------|---------|-------|
| P-001 | 下载超时 | 30 秒 | 取消下载，尝试备用方案 | 总等待时间 < 60 秒 |
| P-002 | API 响应超时 | 60 秒 | 跳过当前配图，继续下一个 | 不因单张图卡住 |
| P-003 | 大文件处理 | PDF > 50MB | 拒绝处理，返回错误 | 清晰错误信息 |
| P-004 | 并发配图请求 | 5 张图同时请求 | 队列处理，避免 API 限流 | 5 张图全部完成 |

---

## 3. 干扰排除测试

| 测试ID | 干扰类型 | 测试方法 | 预期行为 | 验证点 |
|-------|---------|---------|---------|-------|
| I-001 | 网络波动 | 模拟 50% 丢包率 | 自动重试 3 次 | 最终成功或优雅失败 |
| I-002 | 临时目录满 | 磁盘空间不足 | 提前检查，清理或报错 | 清晰错误信息 |
| I-003 | 并发调用 | 同时处理 3 篇论文 | 隔离临时目录，互不干扰 | 3 篇论文全部成功 |
| I-004 | 特殊字符标题 | 论文标题含 emoji/特殊符号 | 文件名安全化处理 | 文件可正常创建 |
| I-005 | 中文 PDF | 全中文论文 | 正确编码处理 | 中文内容完整提取 |
| I-006 | 扫描版 PDF | 图片格式 PDF（无文本层） | OCR 提取或降级处理 | 尽可能提取内容 |
| I-007 | 加密 PDF | 有密码保护的 PDF | 跳过并记录错误 | 不卡住，不崩溃 |

---

## 4. 黄叔风格验证

### 4.1 内容风格检查

| 测试ID | 检查项 | 验证方法 | 通过标准 |
|-------|-------|---------|---------|
| S-001 | 开头无学术套话 | 检查引言前 100 字 | 不出现"在人工智能领域..."等套话 |
| S-002 | 包含类比解释 | 检查正文 | 至少包含 2 个生活化类比 |
| S-003 | 设问引导 | 检查问句数量 | 至少包含 3 个引导性问题 |
| S-004 | 个人点评 | 检查主观判断 | 包含"这意味着...""可以说..."等点评 |
| S-005 | 数字说话 | 检查结果部分 | 包含具体数字对比 |
| S-006 | 开放总结 | 检查结尾 | 以问题或开放讨论结束 |
| S-007 | 格式完整 | 检查章节 | 包含：引子、背景、方法、结果、意义、总结 |

### 4.2 视觉风格检查

| 测试ID | 检查项 | 验证方法 | 通过标准 |
|-------|-------|---------|---------|
| V-001 | 配色正确 | 检查 HTML CSS | 背景 #FDF6E3，强调 #16A085 |
| V-002 | Hero 区格式 | 检查 HTML 结构 | 大标题 + 引号副标题 + 简介 |
| V-003 | 引用框样式 | 检查 CSS | 左侧 4px 青绿边框 |
| V-004 | 页眉页脚 | 检查 @page 规则 | 包含页码和"Paper Interpreter 自动生成" |
| V-005 | 图片说明 | 检查 figcaption | 每张图有居中说明文字 |

---

## 5. 零中断验证

### 5.1 禁止行为检查

| 测试ID | 禁止行为 | 测试方法 | 验证标准 |
|-------|---------|---------|---------|
| Z-001 | 询问确认 | 运行全流程，捕获输出 | 全程无"是否继续"类提示 |
| Z-002 | 询问格式选择 | 运行全流程 | 不询问输出格式 |
| Z-003 | 询问缺失信息 | 使用不完整论文测试 | 不询问用户输入，使用默认值 |
| Z-004 | 等待用户输入 | 后台运行模式测试 | 不因等待输入而挂起 |
| Z-005 | 分块询问 | 使用超长论文测试 | 自动分块，不询问是否继续 |

### 5.2 静默处理验证

| 测试ID | 场景 | 预期日志 | 验证标准 |
|-------|------|---------|---------|
| Z-006 | 配图失败 | `[警告] 配图生成失败，使用占位符继续...` | 流程继续，不退出 |
| Z-007 | 降级提取 | `[警告] 使用降级方案提取内容` | 生成文章，可能有缺失 |
| Z-008 | PDF 导出失败 | `[警告] PDF 导出失败，返回 HTML` | 返回可用文件 |
| Z-009 | 成功完成 | `[成功] 论文解读完成` | 输出完整结果报告 |

---

## 6. 集成测试脚本

```python
#!/usr/bin/env python3
"""
Paper Interpreter 集成测试脚本
运行方式: python test_integration.py
"""

import subprocess
import os
import json
import tempfile
import shutil

TEST_CASES = [
    {
        "id": "T-001",
        "name": "arXiv Mamba 论文",
        "url": "https://arxiv.org/abs/2312.00752",
        "checks": ["article.html", "article.pdf", "metadata.json"]
    },
    {
        "id": "E-012",
        "name": "文件已存在测试",
        "url": "https://arxiv.org/abs/2312.00752",
        "pre_action": "创建同名目录",
        "checks": ["时间戳后缀目录"]
    }
]

def run_test(test_case):
    """运行单个测试用例"""
    print(f"\n{'='*60}")
    print(f"测试 {test_case['id']}: {test_case['name']}")
    print(f"{'='*60}")

    # 执行命令
    cmd = f"/paper-interpreter {test_case['url']}"

    try:
        result = subprocess.run(
            cmd,
            shell=True,
            capture_output=True,
            text=True,
            timeout=300
        )

        # 检查输出
        output = result.stdout + result.stderr

        # 验证检查点
        for check in test_case['checks']:
            if check in output:
                print(f"✅ 通过: {check}")
            else:
                print(f"❌ 失败: 未找到 '{check}'")

        # 检查零中断
        if "?" in output and "http" not in output:
            print("⚠️ 警告: 可能存在用户询问")

    except subprocess.TimeoutExpired:
        print(f"❌ 超时: 测试运行超过 300 秒")
    except Exception as e:
        print(f"❌ 错误: {e}")

def main():
    print("Paper Interpreter 集成测试")
    print("=" * 60)

    for test in TEST_CASES:
        run_test(test)

    print("\n" + "=" * 60)
    print("测试完成")

if __name__ == "__main__":
    main()
```

---

## 7. 测试执行清单

### 部署前必测项

- [ ] T-001: arXiv 链接正常处理
- [ ] E-009: 内容提取失败降级
- [ ] E-010: 配图失败跳过
- [ ] E-012: 文件冲突自动处理
- [ ] Z-001: 全程无用户询问
- [ ] S-001~S-007: 黄叔风格内容检查
- [ ] V-001~V-005: 视觉风格检查

### 回归测试

每次更新后运行：
```bash
python test_integration.py --category=smoke
```

---

## 8. 性能基准

| 指标 | 目标值 | 警告阈值 | 失败阈值 |
|------|-------|---------|---------|
| 论文下载时间 | < 10s | > 30s | > 60s |
| 内容提取时间 | < 15s | > 45s | > 90s |
| 配图生成时间 | < 60s/张 | > 120s/张 | > 180s/张 |
| 文章生成时间 | < 30s | > 60s | > 120s |
| PDF 导出时间 | < 20s | > 40s | > 60s |
| **全流程时间** | **< 3min** | **> 5min** | **> 10min** |

---

*测试矩阵版本: v1.0.0*
*最后更新: 2026-02-22*
